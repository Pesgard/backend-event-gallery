# ================================
# Deploy to AWS EC2 (Ubuntu) - PM2
# ================================
# Despliega autom√°ticamente a 2 instancias EC2 con Ubuntu
# usando PM2 (sin Docker)

name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  # ================================
  # Job 1: Deploy a EC2 #1 + Migraciones
  # ================================
  deploy-ec2-1:
    name: Deploy to EC2 #1 (+ Migrations)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Preparar directorio en EC2 #1
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST_1 }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            # Crear directorio si no existe
            mkdir -p /home/${{ secrets.EC2_USER }}/backend-event-gallery
            # Limpiar contenido anterior
            rm -rf /home/${{ secrets.EC2_USER }}/backend-event-gallery/*

      - name: Copiar c√≥digo a EC2 #1
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST_1 }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          source: "."
          target: "/home/${{ secrets.EC2_USER }}/backend-event-gallery"
          rm: false

      - name: Deploy en EC2 #1
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST_1 }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            echo "üöÄ Iniciando deploy en EC2 #1..."
            
            cd /home/${{ secrets.EC2_USER }}/backend-event-gallery
            
            # Copiar .env.example a .env
            cp env.example .env
            
            # Instalar dependencias
            pnpm install
            
            # Generar cliente de Prisma
            pnpm prisma generate
            
            # Ejecutar migraciones (crear tablas)
            pnpm prisma migrate deploy
            
            # Build de la aplicaci√≥n
            pnpm build
            
            # Detener instancia anterior de PM2 si existe
            pm2 delete backend-event-gallery || true
            
            # Correr con PM2
            pm2 start dist/src/main.js --name backend-event-gallery
            
            # Guardar configuraci√≥n de PM2
            pm2 save
            
            echo "‚úÖ Deploy completado en EC2 #1"

  # ================================
  # Job 2: Deploy a EC2 #2
  # ================================
  deploy-ec2-2:
    name: Deploy to EC2 #2
    runs-on: ubuntu-latest
    needs: deploy-ec2-1

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Preparar directorio en EC2 #2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST_2 }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            # Crear directorio si no existe
            mkdir -p /home/${{ secrets.EC2_USER }}/backend-event-gallery
            # Limpiar contenido anterior
            rm -rf /home/${{ secrets.EC2_USER }}/backend-event-gallery/*

      - name: Copiar c√≥digo a EC2 #2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST_2 }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          source: "."
          target: "/home/${{ secrets.EC2_USER }}/backend-event-gallery"
          rm: false

      - name: Deploy en EC2 #2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST_2 }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            echo "üöÄ Iniciando deploy en EC2 #2..."
            
            cd /home/${{ secrets.EC2_USER }}/backend-event-gallery
            
            # Copiar .env.example a .env
            cp env.example .env
            
            # Instalar dependencias
            pnpm install
            
            # Generar cliente de Prisma
            pnpm prisma generate
            
            # Build de la aplicaci√≥n
            pnpm build
            
            # Detener instancia anterior de PM2 si existe
            pm2 delete backend-event-gallery || true
            
            # Correr con PM2
            pm2 start dist/src/main.js --name backend-event-gallery
            
            # Guardar configuraci√≥n de PM2
            pm2 save
            
            echo "‚úÖ Deploy completado en EC2 #2"

  # ================================
  # Job 3: Health Check
  # ================================
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: [deploy-ec2-1, deploy-ec2-2]

    steps:
      - name: Esperar inicio de servicios
        run: sleep 15

      - name: Verificar servidores
        run: |
          echo "üîç Verificando health..."
          
          for host in "${{ secrets.EC2_HOST_1 }}" "${{ secrets.EC2_HOST_2 }}"; do
            response=$(curl -s -o /dev/null -w "%{http_code}" http://$host:3000/api/health --max-time 10 || echo "000")
            if [ "$response" = "200" ]; then
              echo "‚úÖ $host est√° saludable"
            else
              echo "‚ö†Ô∏è $host respondi√≥ con c√≥digo: $response"
            fi
          done
          
          echo "üéâ Deploy completado!"
