# ================================
# Deploy to AWS EC2 (Ubuntu)
# ================================
# Despliega autom√°ticamente a 2 instancias EC2 con Ubuntu
# cuando se hace push a la rama main

name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  # ================================
  # Job 1: Deploy a EC2 #1 + Migraciones
  # ================================
  deploy-ec2-1:
    name: Deploy to EC2 #1 (+ Migrations)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Copiar c√≥digo a EC2 #1
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST_1 }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          source: "."
          target: "/home/${{ secrets.EC2_USER }}/backend-event-gallery"
          rm: true

      - name: Build, Migrate y Deploy en EC2 #1
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST_1 }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            echo "üöÄ Iniciando deploy en EC2 #1..."
            
            cd /home/${{ secrets.EC2_USER }}/backend-event-gallery
            
            # Copiar archivo .env
            if [ -f /home/${{ secrets.EC2_USER }}/app/.env ]; then
              cp /home/${{ secrets.EC2_USER }}/app/.env .env
            fi
            
            # ========== MIGRACIONES ==========
            echo "üîÑ Ejecutando migraciones..."
            
            # Instalar Node.js si no existe
            if ! command -v node &> /dev/null; then
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi
            
            # Instalar pnpm si no existe
            if ! command -v pnpm &> /dev/null; then
              sudo npm install -g pnpm
            fi
            
            # Instalar dependencias y ejecutar migraciones
            pnpm install --frozen-lockfile
            pnpm prisma generate
            pnpm prisma migrate deploy
            
            echo "‚úÖ Migraciones completadas"
            
            # ========== DOCKER DEPLOY ==========
            echo "üê≥ Desplegando con Docker..."
            
            # Detener contenedor anterior
            docker stop backend-event-gallery || true
            docker rm backend-event-gallery || true
            
            # Build de la imagen
            docker build -t backend-event-gallery:latest .
            
            # Ejecutar contenedor
            docker run -d \
              --name backend-event-gallery \
              --restart unless-stopped \
              -p 3000:3000 \
              --env-file .env \
              backend-event-gallery:latest
            
            # Limpiar im√°genes antiguas
            docker image prune -af
            
            echo "‚úÖ Deploy completado en EC2 #1"

  # ================================
  # Job 2: Deploy a EC2 #2 (sin migraciones)
  # ================================
  deploy-ec2-2:
    name: Deploy to EC2 #2
    runs-on: ubuntu-latest
    needs: deploy-ec2-1  # Espera a que EC2 #1 termine (incluye migraciones)

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Copiar c√≥digo a EC2 #2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST_2 }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          source: "."
          target: "/home/${{ secrets.EC2_USER }}/backend-event-gallery"
          rm: true

      - name: Build y Deploy en EC2 #2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST_2 }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            echo "üöÄ Iniciando deploy en EC2 #2..."
            
            cd /home/${{ secrets.EC2_USER }}/backend-event-gallery
            
            # Copiar archivo .env
            if [ -f /home/${{ secrets.EC2_USER }}/app/.env ]; then
              cp /home/${{ secrets.EC2_USER }}/app/.env .env
            fi
            
            # ========== DOCKER DEPLOY ==========
            echo "üê≥ Desplegando con Docker..."
            
            # Detener contenedor anterior
            docker stop backend-event-gallery || true
            docker rm backend-event-gallery || true
            
            # Build de la imagen
            docker build -t backend-event-gallery:latest .
            
            # Ejecutar contenedor
            docker run -d \
              --name backend-event-gallery \
              --restart unless-stopped \
              -p 3000:3000 \
              --env-file .env \
              backend-event-gallery:latest
            
            # Limpiar im√°genes antiguas
            docker image prune -af
            
            echo "‚úÖ Deploy completado en EC2 #2"

  # ================================
  # Job 3: Health Check
  # ================================
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: [deploy-ec2-1, deploy-ec2-2]

    steps:
      - name: Esperar inicio de servicios
        run: sleep 30

      - name: Verificar servidores
        run: |
          echo "üîç Verificando health..."
          
          for host in "${{ secrets.EC2_HOST_1 }}" "${{ secrets.EC2_HOST_2 }}"; do
            response=$(curl -s -o /dev/null -w "%{http_code}" http://$host:3000/api/health --max-time 10 || echo "000")
            if [ "$response" = "200" ]; then
              echo "‚úÖ $host est√° saludable"
            else
              echo "‚ö†Ô∏è $host respondi√≥ con c√≥digo: $response"
            fi
          done
          
          echo "üéâ Deploy completado!"
